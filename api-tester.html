<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MSC API Tester - Fixed</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
      }
      button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      pre {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
      .debug-info {
        font-size: 12px;
        color: #666;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>MSC Student Portal API Tester (Fixed)</h1>

    <!-- Debug Information -->
    <div class="container warning">
      <h3>üîß Debug Information</h3>
      <div class="debug-info">
        <strong>Current Page:</strong> <span id="currentUrl"></span><br />
        <strong>API Base:</strong> <span id="apiBase"></span><br />
        <strong>Test URL:</strong> <span id="testUrl"></span>
      </div>
      <button onclick="testApiConnection()">Test API Connection</button>
      <button onclick="testAuthEndpoint()">Test Auth Endpoint</button>
    </div>

    <!-- Authentication Section -->
    <div class="container">
      <h2>üîê Authentication</h2>

      <h3>Login</h3>
      <input
        type="text"
        id="loginUsername"
        placeholder="Username"
        value="testuser"
      />
      <input
        type="password"
        id="loginPassword"
        placeholder="Password"
        value="password123"
      />
      <button onclick="testLogin()">Login</button>

      <h3>Register</h3>
      <input
        type="text"
        id="regUsername"
        placeholder="Username"
        value="newuser"
      />
      <input
        type="email"
        id="regEmail"
        placeholder="Email"
        value="newuser@example.com"
      />
      <input
        type="password"
        id="regPassword"
        placeholder="Password"
        value="password123"
      />
      <input
        type="text"
        id="regFirstName"
        placeholder="First Name"
        value="John"
      />
      <input type="text" id="regLastName" placeholder="Last Name" value="Doe" />
      <input
        type="text"
        id="regMiddleName"
        placeholder="Middle Name"
        value="M"
      />
      <input
        type="text"
        id="regNameSuffix"
        placeholder="Name Suffix"
        value=""
      />
      <input
        type="date"
        id="regBirthdate"
        placeholder="Birthdate"
        value="2000-01-01"
      />
      <select id="regGender">
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>
      <input
        type="text"
        id="regStudentNo"
        placeholder="Student Number"
        value="2021-12345"
      />
      <input
        type="text"
        id="regYearLevel"
        placeholder="Year Level"
        value="4th Year"
      />
      <input
        type="text"
        id="regCollege"
        placeholder="College"
        value="College of Engineering"
      />
      <input
        type="text"
        id="regProgram"
        placeholder="Program"
        value="Computer Science"
      />
      <input type="text" id="regSection" placeholder="Section" value="CS-4A" />
      <input
        type="text"
        id="regAddress"
        placeholder="Address"
        value="123 Main St"
      />
      <input
        type="text"
        id="regPhone"
        placeholder="Phone"
        value="09123456789"
      />
      <input
        type="text"
        id="regFacebook"
        placeholder="Facebook Link"
        value=""
      />
      <button onclick="testRegister()">Register</button>

      <h3>Get Profile</h3>
      <button onclick="testGetProfile()">Get My Profile</button>

      <h3>Logout</h3>
      <button onclick="testLogout()">Logout</button>
    </div>

    <!-- Response Section -->
    <div class="container">
      <h2>üì§ API Response</h2>
      <div id="response"></div>
    </div>

    <script>
      // Use relative URL to avoid CORS issues
      const API_BASE = "/msc-website-backend-main/api";

      // Update debug info
      document.getElementById("currentUrl").textContent = window.location.href;
      document.getElementById(
        "apiBase"
      ).textContent = `${window.location.origin}${API_BASE}`;
      document.getElementById(
        "testUrl"
      ).textContent = `${window.location.origin}${API_BASE}/`;

      function displayResponse(data, isError = false) {
        const responseDiv = document.getElementById("response");
        responseDiv.className = `container ${isError ? "error" : "success"}`;
        responseDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      }

      async function apiCall(endpoint, method = "GET", data = null) {
        try {
          const url = `${API_BASE}${endpoint}`;
          console.log(`Making ${method} request to: ${url}`);
          console.log("Data:", data);

          const options = {
            method: method,
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
          };

          if (data) {
            options.body = JSON.stringify(data);
          }

          console.log("Fetch options:", options);

          const response = await fetch(url, options);
          console.log("Response status:", response.status);
          console.log("Response headers:", response.headers);

          // Get the response as text first to see what we actually got
          const responseText = await response.text();
          console.log("Raw response:", responseText);

          // Try to parse as JSON
          let result;
          try {
            result = JSON.parse(responseText);
          } catch (parseError) {
            console.error("JSON parse error:", parseError);
            result = {
              error: "Failed to parse JSON response",
              raw_response: responseText,
              parse_error: parseError.message,
              status: response.status,
              statusText: response.statusText,
            };
          }

          displayResponse(
            {
              status: response.status,
              statusText: response.statusText,
              url: url,
              data: result,
            },
            !response.ok
          );

          return result;
        } catch (error) {
          console.error("Fetch error:", error);
          displayResponse(
            {
              error: error.message,
              type: error.name,
              stack: error.stack,
            },
            true
          );
        }
      }

      // Test functions
      async function testApiConnection() {
        await apiCall("");
      }

      async function testAuthEndpoint() {
        await apiCall("/auth");
      }

      async function testLogin() {
        const username = document.getElementById("loginUsername").value;
        const password = document.getElementById("loginPassword").value;

        await apiCall("/auth/login", "POST", {
          username: username,
          password: password,
        });
      }

      async function testRegister() {
        const data = {
          username: document.getElementById("regUsername").value,
          email: document.getElementById("regEmail").value,
          password: document.getElementById("regPassword").value,
          first_name: document.getElementById("regFirstName").value,
          middle_name: document.getElementById("regMiddleName").value,
          last_name: document.getElementById("regLastName").value,
          name_suffix: document.getElementById("regNameSuffix").value,
          birthdate: document.getElementById("regBirthdate").value,
          gender: document.getElementById("regGender").value,
          student_no: document.getElementById("regStudentNo").value,
          year_level: document.getElementById("regYearLevel").value,
          college: document.getElementById("regCollege").value,
          program: document.getElementById("regProgram").value,
          section: document.getElementById("regSection").value,
          address: document.getElementById("regAddress").value,
          phone: document.getElementById("regPhone").value,
          facebook_link: document.getElementById("regFacebook").value,
        };

        await apiCall("/auth/register", "POST", data);
      }

      async function testGetProfile() {
        await apiCall("/auth/profile");
      }

      async function testLogout() {
        await apiCall("/auth/logout", "POST");
      }
    </script>
  </body>
</html>
