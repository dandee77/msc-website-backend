<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Focused API Test - Login Only</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
      }
      button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      input {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      pre {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>Focused API Test - Login Only</h1>

    <!-- Debug Information -->
    <div class="container warning">
      <h3>üîß Current Status</h3>
      <div id="debug-info">
        <strong>API Base:</strong> <span id="apiBase"></span><br />
        <strong>Test Status:</strong> <span id="testStatus">Ready to test</span>
      </div>
    </div>

    <!-- Test Login Only -->
    <div class="container">
      <h2>üîê Test Login (Only Required Fields)</h2>
      <p>
        <strong
          >Based on SQL schema: username (VARCHAR 50, NOT NULL) and password
          (VARCHAR 255, NOT NULL)</strong
        >
      </p>

      <input
        type="text"
        id="loginUsername"
        placeholder="Username or Email"
        value="testuser"
      />
      <input
        type="password"
        id="loginPassword"
        placeholder="Password"
        value="password123"
      />
      <button onclick="testLogin()">üöÄ Test Login</button>

      <h3>Alternative Test Values:</h3>
      <button onclick="setTestEmail()">Use Email Instead</button>
      <button onclick="setEmptyValues()">Test Empty Values</button>
    </div>

    <!-- Response Section -->
    <div class="container">
      <h2>üì§ API Response & Debug Info</h2>
      <div id="response">No test run yet...</div>
    </div>

    <script>
      // Use relative URL to avoid CORS issues
      const API_BASE = "/msc-website-backend-main/api";

      // Update debug info
      document.getElementById(
        "apiBase"
      ).textContent = `${window.location.origin}${API_BASE}`;

      function updateStatus(message) {
        document.getElementById("testStatus").textContent = message;
      }

      function displayResponse(data, isError = false) {
        const responseDiv = document.getElementById("response");
        responseDiv.className = `container ${isError ? "error" : "success"}`;
        responseDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      }

      async function apiCall(endpoint, method = "GET", data = null) {
        updateStatus(`Making ${method} request to ${endpoint}...`);

        try {
          const url = `${API_BASE}${endpoint}`;
          console.log(`üöÄ Making ${method} request to: ${url}`);
          console.log("üì§ Request data:", data);

          const options = {
            method: method,
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
          };

          if (data) {
            options.body = JSON.stringify(data);
          }

          console.log("‚öôÔ∏è Fetch options:", options);

          const response = await fetch(url, options);
          console.log("üì• Response status:", response.status);
          console.log("üì• Response headers:", [...response.headers.entries()]);

          // Get the response as text first to see what we actually got
          const responseText = await response.text();
          console.log("üì• Raw response text:", responseText);

          // Try to parse as JSON
          let result;
          try {
            result = JSON.parse(responseText);
            console.log("‚úÖ Parsed JSON successfully:", result);
          } catch (parseError) {
            console.error("‚ùå JSON parse error:", parseError);
            result = {
              error: "Failed to parse JSON response",
              raw_response: responseText,
              parse_error: parseError.message,
              status: response.status,
              statusText: response.statusText,
              url: url,
              content_type: response.headers.get("content-type"),
            };
          }

          const debugInfo = {
            request: {
              url: url,
              method: method,
              data: data,
            },
            response: {
              status: response.status,
              statusText: response.statusText,
              contentType: response.headers.get("content-type"),
              ok: response.ok,
            },
            result: result,
          };

          displayResponse(debugInfo, !response.ok);
          updateStatus(
            response.ok
              ? "‚úÖ Request completed successfully"
              : "‚ùå Request failed"
          );

          return result;
        } catch (error) {
          console.error("üí• Fetch error:", error);
          const errorInfo = {
            error: "Network/Fetch Error",
            message: error.message,
            type: error.name,
            stack: error.stack,
          };
          displayResponse(errorInfo, true);
          updateStatus("üí• Network error occurred");
          return null;
        }
      }

      // Test functions
      async function testLogin() {
        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value.trim();

        console.log("üîê Testing login with:", { username, password: "***" });

        await apiCall("/auth/login", "POST", {
          username: username,
          password: password,
        });
      }

      // Helper functions
      function setTestEmail() {
        document.getElementById("loginUsername").value = "test@example.com";
        updateStatus("Switched to email test");
      }

      function setEmptyValues() {
        document.getElementById("loginUsername").value = "";
        document.getElementById("loginPassword").value = "";
        updateStatus("Set empty values for validation test");
      }
    </script>
  </body>
</html>
